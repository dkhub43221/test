--// AUTO LOOT ALL BODIES â€“ DKHub Version
--// Fires LootPlayerRF on every eligible dead body

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Teams = game:GetService("Teams")

local LootRF = game:GetService("ReplicatedStorage"):WaitForChild("LootPlayerRF")
local Notify = require(LocalPlayer.PlayerGui.NotificationUI.NotificationModule)

-- SETTINGS
local AutoLootEnabled = true
local LootRange = 25 -- how close you must be to loot

-- Convert loot table to readable text
local function LootToText(tbl)
    if not tbl or #tbl == 0 then
        return "You looted nothing!"
    end

    local msg = "You Looted: "
    for i, v in ipairs(tbl) do
        msg = msg .. v.Name
        if i < #tbl then msg = msg .. ", " end
    end
    return msg
end

-- MAIN LOOP
task.spawn(function()
    while task.wait(0.25) do
        if not AutoLootEnabled then continue end

        local myChar = LocalPlayer.Character
        local hrp = myChar and myChar:FindFirstChild("HumanoidRootPart")
        if not hrp then continue end

        for _, plr in ipairs(Players:GetPlayers()) do
            if plr == LocalPlayer then continue end

            -- Ignore cops
            if plr.Team == Teams["Police Met"] then
                continue
            end

            local char = plr.Character
            if not char then continue end

            local hum = char:FindFirstChild("Humanoid")
            local torso = char:FindFirstChild("UpperTorso")

            if hum and hum.Health <= 0 and torso then

                -- Already looted?
                if char:GetAttribute("Looted") == true then
                    continue
                end

                -- Safezone?
                if char:GetAttribute("InSafeZone") == true then
                    continue
                end

                -- Distance check
                local dist = (torso.Position - hrp.Position).Magnitude
                if dist > LootRange then
                    continue
                end

                -- Fire loot remote
                local loot = LootRF:InvokeServer(plr)

                -- Notify
                Notify.addNotification(LootToText(loot))
            end
        end
    end
end)
